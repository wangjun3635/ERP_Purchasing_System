<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.team.purchasing.mapper.BiddingDao">

	<sql id = "sql_queryBiddingList">
		id,
		userId,
		hcId,
		brandName,
		drugName,
		unit,
		quantity,
		supplierCategory,
		expireDay,
		auditStatus,
		remark,
		createTime,
		createUserId,
		updateTime,
		updateUserId
	</sql>

	<select id="queryBiddingList" 
		parameterType="com.team.purchasing.controller.request.QueryBiddingListRequest"
		resultType="com.team.purchasing.bean.Bidding">
		
		select 
			top (#{page.currentNum}),
			t.*
		from 
			(
			select 
				SELECT ROW_NUMBER() OVER ( tb_bargain.createTime DESC ) AS rownum ,
				<include refid="sql_queryBiddingList"/>
			from tb_bidding
			where t.hcId = #{hcId}
			) t
		where t.rownumber <![CDATA[ > ]]> #{page.rowNumber}
	</select>
	
	<select id="countBiddingList"
	 parameterType="com.team.purchasing.controller.request.QueryBiddingListRequest"
	 resultType="java.lang.Integer">
	 	select count(*) from tb_bidding
	 	where t.t.hcId = #{hcId}
	</select>
   
    <select id="queryBiddingListForSupplier"
    	parameterType="com.team.purchasing.controller.request.QueryBiddingListRequest"
		resultType="com.team.purchasing.bean.Bidding">
    
    	select 
    		top (#{page.currentNum}),
    		t4.*
       from(
    	select 
    		SELECT ROW_NUMBER() OVER ( tb_bargain.createTime DESC ) AS rownum ,
    		<include refid="sql_queryBiddingList"/>
    	from tb_bidding
    	  where EXISTS (
    	  				select t3.*
	    	  			(select t.categoryid 
	    	  			 from tb_bidding_supplier_category t 
	    	  			  where t.biddingid = id
	    	  			InterSect
	    	  			select t1.categoryid
	    	  			 from tb_supplier_category t1
	    	  			 where t1.supplierid = #{supplierId}
	    	  			 ) t3
    	  				)
       	) t4
       	where t4.rownumber <![CDATA[ > ]]> #{page.rowNumber}
    </select>
   
   <select id = "countBiddingListForSupplier"
   	 parameterType="com.team.purchasing.controller.request.QueryBiddingListRequest"
	 resultType="java.lang.Integer">
	 select count(*) 
	 	from tb_bidding
	 where EXISTS (
   	  				select t3.*
    	  			(select t.categoryid 
    	  			 from tb_bidding_supplier_category t 
    	  			  where t.biddingid = id
    	  			InterSect
    	  			select t1.categoryid
    	  			 from tb_supplier_category t1
    	  			 where t1.supplierid = #{supplierId}
    	  			 ) t3
    	  			)
   </select>
   
   <insert id="createBidding" 
   		parameterType="com.team.purchasing.bean.Bidding">
   		insert into tb_bidding(
   			userId,
			hcId,
			brandName,
			drugName,
			unit,
			quantity,
			supplierCategory,
			expireDay,
			auditStatus,
			remark,
			createTime,
			createUserId
   		)values (
   			#{bidding.userId},
   			#{bidding.hcId},
   			#{bidding.drugName},
   			#{bidding.unit},
   			#{bidding.quantity},
   			#{bidding.supplierCategory},
   			#{bidding.expireDay},
   			#{bidding.remark},
   			getdate(),
   			#{baseUserInfo.userId}
   		)
   </insert>
   
   <insert id="createBiddingComment"
   	parameterType="com.team.purchasing.bean.BiddingComment">
   		insert into tb_bidding_comment(
			biddingId,
			supplierId,
			unitPrice,
			remark,
			isSelected,
			createTime,
			createUserId
   		)values(
   			#{biddingComment.biddingId},
   			#{biddingComment.supplierId},
   			#{biddingComment.unitPrice},
   			#{biddingComment.remark},
   			#{biddingComment.isSelected},
			getdate(),
			#{baseUserInfo.userId}
   		)
   </insert>
   
</mapper>